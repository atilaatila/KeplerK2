import numpy as np
from astropy.io import fits
import os

dir_data = '/Users/patrick/Documents/boulot/kepler/cambouis/donnees/neptune/fich_bruts/'
file_list = [f for f in os.listdir(dir_data) if f.endswith('c03_lpd-targ.fits')]
N_file = len(file_list)

# Loop over the headers to get column and row information
N_date_ii = []
col_start = []
row_start = []
N_pix = []

for ii in range(N_file):
    file_name = os.path.join(dir_data, file_list[ii])
    header = fits.getheader(file_name, ext=1)
    
    # From header binary table
    with fits.open(file_name) as hdul:
        N_date_ii.append(len(hdul[1].data))
    
    # From header image
    key = header
    col_start.append(key['CRVAL1P'])
    row_start.append(key['CRVAL2P'])
    N_pix.append(key['NAXIS2'])

# Filling up the big array by assembling columns into images
col_min = min(col_start)
col_max = max(col_start)
N_col = col_max - col_min + 1
row_min = min(row_start)
row_max = max(row_start[i] + N_pix[i] for i in range(N_file))
N_row = row_max - row_min + 1
N_date = max(N_date_ii)

# Loop over the files
image_time_series = np.zeros((N_row, N_date, N_file))

for ii in range(N_file):
    file_name = os.path.join(dir_data, file_list[ii])
    with fits.open(file_name) as hdul:
        tab = hdul[1].data
        col_sap_ii = tab.field(3)  # Assuming the 4th field is at index 3
        ind_y_min = row_start[ii] - row_min
        ind_y_max = ind_y_min + N_pix[ii]
        image_time_series[ind_y_min:ind_y_max, :, ii] = col_sap_ii.T